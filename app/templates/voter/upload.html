{% extends "base.html" %}

{% block title %}Upload Excel - Voter Management System{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#preview-btn').click(function() {
        const fileInput = $('#file')[0];
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select an Excel file first');
            return;
        }
        
        const file = fileInput.files[0];
        
        // Create FormData object
        const formData = new FormData();
        formData.append('file', file);
        
        // Show preview section
        $('#preview-section').show();
        
        // Make AJAX request to preview Excel
        $.ajax({
            url: '{{ url_for("voter.preview_excel") }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Build preview table
                    let html = '';
                    
                    // Show file info
                    html += `<div class="mb-3">
                        <div class="alert alert-primary">
                            <strong>File Information:</strong><br>
                            Total Rows: ${response.total_rows}<br>
                            Columns: ${response.columns.length}<br>
                            Column Names: ${response.columns.join(', ')}
                        </div>
                    </div>`;
                    
                    // Create table for preview data
                    if (response.preview_data.length > 0) {
                        html += '<div class="table-responsive"><table class="table table-striped table-bordered">';
                        
                        // Add table header
                        html += '<thead class="table-dark"><tr>';
                        response.columns.forEach(function(col) {
                            html += `<th>${col}</th>`;
                        });
                        html += '</tr></thead>';
                        
                        // Add table body
                        html += '<tbody>';
                        response.preview_data.forEach(function(row) {
                            html += '<tr>';
                            response.columns.forEach(function(col) {
                                const cellValue = row[col] !== null && row[col] !== undefined ? row[col] : '';
                                html += `<td>${cellValue}</td>`;
                            });
                            html += '</tr>';
                        });
                        html += '</tbody>';
                        
                        html += '</table></div>';
                        
                        if (response.preview_data.length < response.total_rows) {
                            html += `<div class="alert alert-info mt-3">
                                Showing first ${response.preview_data.length} rows out of ${response.total_rows} total rows.
                            </div>`;
                        }
                    } else {
                        html += '<div class="alert alert-warning">No data found in the Excel file.</div>';
                    }
                    
                    $('#preview-content').html(html);
                } else {
                    $('#preview-content').html(`<div class="alert alert-danger">Error: ${response.message}</div>`);
                }
            },
            error: function(xhr, status, error) {
                $('#preview-content').html(`<div class="alert alert-danger">Error: Could not preview Excel file. ${xhr.responseJSON ? xhr.responseJSON.message : 'Please check the file format.'}</div>`);
            }
        });
    });
});
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-file-upload me-2"></i>Upload Voter Data</h2>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card dashboard-card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="upload-form">
                    <div class="mb-4">
                        <label for="file" class="form-label"><i class="fas fa-file-excel text-success me-2"></i>Select Excel File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle me-1"></i> Supported formats: .xlsx, .xls
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('voter.search') }}" class="btn btn-secondary action-btn me-md-2">
                            <i class="fas fa-arrow-left me-1"></i> Back to Search
                        </a>
                        <button type="button" class="btn btn-info action-btn me-md-2" id="preview-btn">
                            <i class="fas fa-eye me-1"></i> Preview
                        </button>
                        <button type="submit" class="btn btn-success action-btn">
                            <i class="fas fa-upload me-1"></i> Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Excel Preview Section -->
        <div class="card dashboard-card mt-4" id="preview-section" style="display: none;">
            <div class="card-header">
                <h4><i class="fas fa-table me-2"></i>Excel File Preview</h4>
            </div>
            <div class="card-body">
                <div id="preview-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading preview...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card dashboard-card mt-4">
            <div class="card-header">
                <h4><i class="fas fa-table me-2"></i>Excel File Format Guide</h4>
            </div>
            <div class="card-body">
                <p>The system will automatically detect and map your Excel columns to the appropriate voter data fields. Column names are case-insensitive and can be in any order:</p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-id-card text-primary me-2"></i>Voter ID</span>
                                <span class="badge bg-info">voter, id, voterid, etc.</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-hashtag text-primary me-2"></i>Booth No</span>
                                <span class="badge bg-info">booth, booth no, boothno, etc.</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user text-primary me-2"></i>Name</span>
                                <span class="badge bg-info">name, first name, fname, etc.</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-friends text-primary me-2"></i>Father Name</span>
                                <span class="badge bg-info">father, father name, etc.</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-tag text-primary me-2"></i>Surname</span>
                                <span class="badge bg-info">surname, last name, lname, etc.</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-circle text-primary me-2"></i>Full Name</span>
                                <span class="badge bg-info">full name, fullname, etc.</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-mobile-alt text-primary me-2"></i>Mobile Number</span>
                                <span class="badge bg-info">mobile, phone, mobile no, etc.</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i> <strong>Note:</strong> 
                    If no Voter ID column is found, the system will automatically generate unique IDs. Duplicates will be skipped. Only new voters will be added to the system.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}